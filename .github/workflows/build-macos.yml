name: Build RV Verge (macOS)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-macos:
    name: Build for macOS
    runs-on: macos-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for version calculation

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache Cargo build
        uses: actions/cache@v4
        with:
          path: |
            src-tauri/target
          key: ${{ runner.os }}-cargo-target-macos-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-target-macos-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Install project dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Calculate version
        id: version
        run: |
          # Calculate version based on commit count (自动版本递增)
          # Format: 0.1.${COMMIT_COUNT}
          BASE_VERSION="0.1"
          COMMIT_COUNT=$(git rev-list --count HEAD)
          VERSION="${BASE_VERSION}.${COMMIT_COUNT}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION (based on commit count: $COMMIT_COUNT)"
          
          # Update package.json and Cargo.toml with new version (构建前更新版本)
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '$VERSION';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
            console.log('Updated package.json version to', pkg.version);
          "
          
          # Update Cargo.toml version
          sed -i '' "s/^version = \".*\"/version = \"$VERSION\"/" src-tauri/Cargo.toml
          echo "Updated Cargo.toml version to $VERSION"

      - name: Run prebuild
        run: |
          npm run prebuild || echo "Warning: prebuild failed, continuing..."

      - name: Build Tauri application (ARM64)
        run: |
          # Build frontend first (beforeBuildCommand will also run, but we want to ensure it's built)
          npm run web:build
          # Use fast-release profile for faster builds (极致速度组合)
          # Note: beforeBuildCommand is set to "npm run web:build" in tauri.conf.json
          # but we build it here explicitly to ensure it's ready
          npm run tauri build -- --target aarch64-apple-darwin -- --profile fast-release

      - name: Build Tauri application (x64)
        run: |
          # Use fast-release profile for faster builds (极致速度组合)
          npm run tauri build -- --target x86_64-apple-darwin -- --profile fast-release || echo "x64 build skipped (may not be available)"

      - name: Prepare release files
        id: release_files
        run: |
          # Find all release files (修复release文件上传问题)
          # Note: We use fast-release profile, so files are in fast-release directory
          RELEASE_FILES=()
          
          # ARM64 DMG (fast-release profile)
          if [ -d "src-tauri/target/aarch64-apple-darwin/fast-release/bundle/dmg" ]; then
            for file in src-tauri/target/aarch64-apple-darwin/fast-release/bundle/dmg/*.dmg; do
              if [ -f "$file" ]; then
                RELEASE_FILES+=("$file")
                echo "✓ Found ARM64 DMG: $(basename "$file")"
              fi
            done
          elif [ -d "src-tauri/target/aarch64-apple-darwin/release/bundle/dmg" ]; then
            # Fallback to release profile
            for file in src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg; do
              if [ -f "$file" ]; then
                RELEASE_FILES+=("$file")
                echo "✓ Found ARM64 DMG: $(basename "$file")"
              fi
            done
          else
            echo "✗ ARM64 DMG directory not found"
          fi
          
          # ARM64 macOS app (zip it for release)
          if [ -d "src-tauri/target/aarch64-apple-darwin/fast-release/bundle/macos" ]; then
            for file in src-tauri/target/aarch64-apple-darwin/fast-release/bundle/macos/*.app; do
              if [ -d "$file" ]; then
                # Create zip file for .app bundle
                APP_NAME=$(basename "$file" .app)
                ZIP_FILE="src-tauri/target/aarch64-apple-darwin/fast-release/bundle/macos/${APP_NAME}-aarch64.zip"
                cd "src-tauri/target/aarch64-apple-darwin/fast-release/bundle/macos"
                zip -r "${APP_NAME}-aarch64.zip" "${APP_NAME}.app" || true
                cd - > /dev/null
                if [ -f "$ZIP_FILE" ]; then
                  RELEASE_FILES+=("$ZIP_FILE")
                  echo "✓ Found ARM64 ZIP: $(basename "$ZIP_FILE")"
                fi
              fi
            done
          elif [ -d "src-tauri/target/aarch64-apple-darwin/release/bundle/macos" ]; then
            # Fallback to release profile
            for file in src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app; do
              if [ -d "$file" ]; then
                # Create zip file for .app bundle
                APP_NAME=$(basename "$file" .app)
                ZIP_FILE="src-tauri/target/aarch64-apple-darwin/release/bundle/macos/${APP_NAME}-aarch64.zip"
                cd "src-tauri/target/aarch64-apple-darwin/release/bundle/macos"
                zip -r "${APP_NAME}-aarch64.zip" "${APP_NAME}.app" || true
                cd - > /dev/null
                if [ -f "$ZIP_FILE" ]; then
                  RELEASE_FILES+=("$ZIP_FILE")
                  echo "✓ Found ARM64 ZIP: $(basename "$ZIP_FILE")"
                fi
              fi
            done
          else
            echo "✗ ARM64 app directory not found"
          fi
          
          # x64 DMG (if available, fast-release profile)
          if [ -d "src-tauri/target/x86_64-apple-darwin/fast-release/bundle/dmg" ]; then
            for file in src-tauri/target/x86_64-apple-darwin/fast-release/bundle/dmg/*.dmg; do
              if [ -f "$file" ]; then
                RELEASE_FILES+=("$file")
                echo "✓ Found x64 DMG: $(basename "$file")"
              fi
            done
          elif [ -d "src-tauri/target/x86_64-apple-darwin/release/bundle/dmg" ]; then
            # Fallback to release profile
            for file in src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg; do
              if [ -f "$file" ]; then
                RELEASE_FILES+=("$file")
                echo "✓ Found x64 DMG: $(basename "$file")"
              fi
            done
          fi
          
          # x64 macOS app (if available, fast-release profile)
          if [ -d "src-tauri/target/x86_64-apple-darwin/fast-release/bundle/macos" ]; then
            for file in src-tauri/target/x86_64-apple-darwin/fast-release/bundle/macos/*.app; do
              if [ -d "$file" ]; then
                # Create zip file for .app bundle
                APP_NAME=$(basename "$file" .app)
                ZIP_FILE="src-tauri/target/x86_64-apple-darwin/fast-release/bundle/macos/${APP_NAME}-x64.zip"
                cd "src-tauri/target/x86_64-apple-darwin/fast-release/bundle/macos"
                zip -r "${APP_NAME}-x64.zip" "${APP_NAME}.app" || true
                cd - > /dev/null
                if [ -f "$ZIP_FILE" ]; then
                  RELEASE_FILES+=("$ZIP_FILE")
                  echo "✓ Found x64 ZIP: $(basename "$ZIP_FILE")"
                fi
              fi
            done
          elif [ -d "src-tauri/target/x86_64-apple-darwin/release/bundle/macos" ]; then
            # Fallback to release profile
            for file in src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app; do
              if [ -d "$file" ]; then
                # Create zip file for .app bundle
                APP_NAME=$(basename "$file" .app)
                ZIP_FILE="src-tauri/target/x86_64-apple-darwin/release/bundle/macos/${APP_NAME}-x64.zip"
                cd "src-tauri/target/x86_64-apple-darwin/release/bundle/macos"
                zip -r "${APP_NAME}-x64.zip" "${APP_NAME}.app" || true
                cd - > /dev/null
                if [ -f "$ZIP_FILE" ]; then
                  RELEASE_FILES+=("$ZIP_FILE")
                  echo "✓ Found x64 ZIP: $(basename "$ZIP_FILE")"
                fi
              fi
            done
          fi
          
          # Check if files exist
          if [ ${#RELEASE_FILES[@]} -eq 0 ]; then
            echo "Error: No release files found!"
            echo "Build directory contents:"
            find src-tauri/target -name "*.dmg" -o -name "*.app" 2>/dev/null | head -20 || echo "Cannot list files"
            exit 1
          fi
          
          echo ""
          echo "Found ${#RELEASE_FILES[@]} release file(s):"
          for file in "${RELEASE_FILES[@]}"; do
            echo "  - $file ($(du -h "$file" | cut -f1))"
          done
          
          # Output files list (每行一个文件路径，使用multiline format)
          {
            echo "files<<EOF"
            printf '%s\n' "${RELEASE_FILES[@]}"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create or update GitHub Release (macOS)
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: RV Verge v${{ steps.version.outputs.version }}
          body: |
            ## RV Verge v${{ steps.version.outputs.version }}
            
            **Build Date:** ${{ github.event.head_commit.timestamp }}
            **Commit:** ${{ github.sha }}
            
            ### RISC-V (Linux)
            
            - **Architecture:** RISCV64 (riscv64gc-unknown-linux-gnu)
            - **Built on:** Self-hosted RISCV64 runner
            - **DEB Package:** For Debian/Ubuntu based systems
            - **RPM Package:** For Red Hat/Fedora based systems
            - **Binary:** Standalone executable
            
            ### macOS
            
            - **Architecture:** ARM64 (Apple Silicon) and x64 (Intel)
            - **Built on:** GitHub Actions macOS runner
            - **DMG:** Disk image for easy installation
            - **App:** macOS application bundle (zip)
          files: ${{ steps.release_files.outputs.files }}
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
          generate_release_notes: false
          append_body: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rv-verge-macos
          path: |
            src-tauri/target/aarch64-apple-darwin/fast-release/bundle/
            src-tauri/target/x86_64-apple-darwin/fast-release/bundle/
            src-tauri/target/aarch64-apple-darwin/release/bundle/
            src-tauri/target/x86_64-apple-darwin/release/bundle/
