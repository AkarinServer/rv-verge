name: Build RV Verge (macOS)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-macos:
    name: Build for macOS
    runs-on: macos-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for version calculation

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache Cargo build
        uses: actions/cache@v4
        with:
          path: |
            src-tauri/target
          key: ${{ runner.os }}-cargo-target-macos-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-target-macos-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Install project dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Calculate version
        id: version
        run: |
          # Calculate version based on commit count (自动版本递增)
          # Format: 0.1.${COMMIT_COUNT}
          BASE_VERSION="0.1"
          COMMIT_COUNT=$(git rev-list --count HEAD)
          VERSION="${BASE_VERSION}.${COMMIT_COUNT}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION (based on commit count: $COMMIT_COUNT)"
          
          # Update package.json and Cargo.toml with new version (构建前更新版本)
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '$VERSION';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
            console.log('Updated package.json version to', pkg.version);
          "
          
          # Update Cargo.toml version
          sed -i '' "s/^version = \".*\"/version = \"$VERSION\"/" src-tauri/Cargo.toml
          echo "Updated Cargo.toml version to $VERSION"
          
          # Update tauri.conf.json version (required for correct package naming)
          node -e "
            const fs = require('fs');
            const tauriConfig = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
            tauriConfig.version = '$VERSION';
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(tauriConfig, null, 2) + '\n');
            console.log('Updated tauri.conf.json version to', tauriConfig.version);
          "
          
      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous release tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            # No previous tag, get all commits
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # Get commits since last tag
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          if [ -z "$COMMITS" ]; then
            CHANGELOG="## What's Changed
          
          No significant changes in this release."
          else
            CHANGELOG="## What's Changed
          
          $COMMITS"
          fi
          
          # Output changelog (escape newlines for GitHub Actions)
          {
            echo "changelog<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "Generated changelog:"
          echo "$CHANGELOG"
          
      - name: Format build date
        id: build_date
        run: |
          # Format build date in a readable format (macOS date command)
          # Try to use UTC timezone for consistency
          if [ -n "${{ github.event.head_commit.timestamp }}" ]; then
            # Parse and format the timestamp (macOS uses -j and -f)
            # Format: 2025-11-13T13:12:23+08:00 -> 2025-11-13 05:12:23 UTC
            TIMESTAMP="${{ github.event.head_commit.timestamp }}"
            # Remove timezone offset and convert to UTC format
            BUILD_DATE=$(date -u -j -f "%Y-%m-%dT%H:%M:%S%z" "$TIMESTAMP" "+%Y-%m-%d %H:%M:%S UTC" 2>/dev/null || date -u -j -f "%Y-%m-%dT%H:%M:%S" "${TIMESTAMP%%+*}" "+%Y-%m-%d %H:%M:%S UTC" 2>/dev/null || echo "$TIMESTAMP")
          else
            # Fallback to current time
            BUILD_DATE=$(date -u "+%Y-%m-%d %H:%M:%S UTC")
          fi
          
          echo "date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "Formatted build date: $BUILD_DATE"

      - name: Run prebuild
        run: |
          npm run prebuild || echo "Warning: prebuild failed, continuing..."

      - name: Build Tauri application (ARM64)
        run: |
          # Build frontend first (beforeBuildCommand will also run, but we want to ensure it's built)
          npm run web:build
          # Use fast-release profile for faster builds (极致速度组合)
          # Note: beforeBuildCommand is set to "npm run web:build" in tauri.conf.json
          # but we build it here explicitly to ensure it's ready
          npm run tauri build -- --target aarch64-apple-darwin -- --profile fast-release

      - name: Prepare release files
        id: release_files
        run: |
          # Find all release files (修复release文件上传问题)
          # Note: We use fast-release profile, so files are in fast-release directory
          RELEASE_FILES=()
          
          # ARM64 DMG (fast-release profile) - rename to include system name (macos)
          if [ -d "src-tauri/target/aarch64-apple-darwin/fast-release/bundle/dmg" ]; then
            for file in src-tauri/target/aarch64-apple-darwin/fast-release/bundle/dmg/*.dmg; do
              if [ -f "$file" ]; then
                # Rename: RV.Verge_0.1.74_aarch64.dmg -> RV.Verge_0.1.74_macos_aarch64.dmg
                DIR=$(dirname "$file")
                FILENAME=$(basename "$file")
                NEW_FILENAME=$(echo "$FILENAME" | sed -E 's/_([0-9]+\.[0-9]+\.[0-9]+)_([a-z0-9]+)\.dmg$/_\1_macos_\2.dmg/')
                NEW_FILE="$DIR/$NEW_FILENAME"
                
                if [ "$FILENAME" != "$NEW_FILENAME" ] && [ -f "$file" ]; then
                  mv "$file" "$NEW_FILE"
                  echo "✓ Renamed ARM64 DMG: $FILENAME -> $NEW_FILENAME"
                  RELEASE_FILES+=("$NEW_FILE")
                else
                  RELEASE_FILES+=("$file")
                  echo "✓ Found ARM64 DMG: $FILENAME"
                fi
              fi
            done
          elif [ -d "src-tauri/target/aarch64-apple-darwin/release/bundle/dmg" ]; then
            # Fallback to release profile
            for file in src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg; do
              if [ -f "$file" ]; then
                # Rename: RV.Verge_0.1.74_aarch64.dmg -> RV.Verge_0.1.74_macos_aarch64.dmg
                DIR=$(dirname "$file")
                FILENAME=$(basename "$file")
                NEW_FILENAME=$(echo "$FILENAME" | sed -E 's/_([0-9]+\.[0-9]+\.[0-9]+)_([a-z0-9]+)\.dmg$/_\1_macos_\2.dmg/')
                NEW_FILE="$DIR/$NEW_FILENAME"
                
                if [ "$FILENAME" != "$NEW_FILENAME" ] && [ -f "$file" ]; then
                  mv "$file" "$NEW_FILE"
                  echo "✓ Renamed ARM64 DMG: $FILENAME -> $NEW_FILENAME"
                  RELEASE_FILES+=("$NEW_FILE")
                else
                  RELEASE_FILES+=("$file")
                  echo "✓ Found ARM64 DMG: $FILENAME"
                fi
              fi
            done
          else
            echo "⚠ ARM64 DMG directory not found, will try to use .app bundle instead"
          fi
          
          # If DMG not found, try to use .app bundle (fallback)
          if [ ${#RELEASE_FILES[@]} -eq 0 ]; then
            echo "DMG not available, looking for .app bundle..."
            APP_BUNDLE=""
            if [ -d "src-tauri/target/aarch64-apple-darwin/fast-release/bundle/macos" ]; then
              APP_BUNDLE=$(find src-tauri/target/aarch64-apple-darwin/fast-release/bundle/macos -name "*.app" -type d | head -1)
            elif [ -d "src-tauri/target/aarch64-apple-darwin/release/bundle/macos" ]; then
              APP_BUNDLE=$(find src-tauri/target/aarch64-apple-darwin/release/bundle/macos -name "*.app" -type d | head -1)
            fi
            
            if [ -n "$APP_BUNDLE" ] && [ -d "$APP_BUNDLE" ]; then
              echo "✓ Found .app bundle: $APP_BUNDLE"
              # Create a zip of the .app bundle for release
              APP_NAME=$(basename "$APP_BUNDLE" .app)
              ZIP_PATH="$(dirname "$APP_BUNDLE")/${APP_NAME}.zip"
              cd "$(dirname "$APP_BUNDLE")"
              zip -r "${APP_NAME}.zip" "${APP_NAME}.app" > /dev/null 2>&1
              RELEASE_FILES+=("$ZIP_PATH")
              echo "✓ Created zip archive: $ZIP_PATH"
            fi
          fi
          
          # Check if files exist
          if [ ${#RELEASE_FILES[@]} -eq 0 ]; then
            echo "Error: No release files found!"
            echo "Build directory contents:"
            find src-tauri/target -name "*.dmg" -o -name "*.app" 2>/dev/null | head -20 || echo "Cannot list files"
            exit 1
          fi
          
          echo ""
          echo "Found ${#RELEASE_FILES[@]} release file(s):"
          for file in "${RELEASE_FILES[@]}"; do
            echo "  - $file ($(du -h "$file" | cut -f1))"
          done
          
          # Output files list (每行一个文件路径，使用multiline format)
          {
            echo "files<<EOF"
            printf '%s\n' "${RELEASE_FILES[@]}"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create or update GitHub Release (macOS)
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: RV Verge v${{ steps.version.outputs.version }}
          body: |
            ## RV Verge v${{ steps.version.outputs.version }}
            
            **Build Date:** ${{ steps.build_date.outputs.date }}
            **Commit:** ${{ github.sha }}
            
            ${{ steps.changelog.outputs.changelog }}
            
            ### Downloads
            
            #### RISC-V (Linux)
            
            - **Architecture:** RISCV64 (riscv64gc-unknown-linux-gnu)
            - **Built on:** Self-hosted RISCV64 runner
            - **DEB Package:** For Debian/Ubuntu based systems
            - **RPM Package:** For Red Hat/Fedora based systems
            - **Binary:** Standalone executable
            
            #### macOS
            
            - **Architecture:** ARM64 (Apple Silicon)
            - **Built on:** GitHub Actions macOS runner
            - **DMG:** Disk image for easy installation
          files: ${{ steps.release_files.outputs.files }}
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
          generate_release_notes: false
          append_body: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rv-verge-macos
          path: |
            src-tauri/target/aarch64-apple-darwin/fast-release/bundle/
            src-tauri/target/aarch64-apple-darwin/release/bundle/
