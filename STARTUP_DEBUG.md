# 后端启动诊断和调试工具

## 概述

为了解决后端启动时可能出现的阻塞问题，我添加了以下诊断和超时保护机制：

## 新增的诊断工具

### 1. `debug_startup.rs` 模块

位置：`src-tauri/src/utils/debug_startup.rs`

功能：
- `StartupProfiler`: 启动性能分析器，跟踪各个启动阶段的耗时
- `with_timeout()`: 带超时的异步函数执行包装器，自动检测超时并输出诊断信息

### 2. 启动流程中的超时保护

在 `src-tauri/src/utils/resolve/mod.rs` 中添加了以下超时保护：

#### a. `init_verge_config()` - 10秒超时
- 配置初始化是启动的关键步骤
- 如果超过10秒未完成，会记录错误但继续启动

#### b. `init_window()` - 15秒超时
- 窗口创建是用户可见的关键步骤
- 如果超过15秒未完成，会记录错误但继续启动

#### c. `init_service_manager()` - 10秒超时
- 服务管理器初始化
- 如果超时，会记录错误但继续启动

#### d. `init_core_manager()` - 30秒超时（已有，增强诊断）
- 核心管理器初始化是最可能阻塞的地方
- 添加了详细的诊断输出，包括开始、完成、失败和超时信息

#### e. `init_system_proxy()` - 5秒超时
- 系统代理设置
- 如果超时，会记录错误但继续启动

## 诊断输出

所有诊断信息会同时输出到：
1. **stderr (eprintln!)**: 立即在控制台显示，即使日志系统未初始化
2. **日志系统**: 通过 `logging!` 宏记录到日志文件

诊断信息格式：
```
[启动诊断] 开始阶段: <阶段名称>
[启动诊断] ✓ <阶段名称> 完成 (耗时: <时间>)
[启动诊断] ✗ <阶段名称> 超时 (已运行: <时间>, 超时限制: <时间>)
```

## 使用方法

### 1. 编译并运行

```bash
cd src-tauri
cargo build
cargo run
```

### 2. 查看诊断输出

诊断信息会输出到：
- **控制台 (stderr)**: 直接查看终端输出
- **日志文件**: 查看应用日志目录中的日志文件

### 3. 识别阻塞点

如果某个阶段出现超时，诊断输出会明确显示：
- 哪个阶段超时了
- 已经运行了多长时间
- 超时限制是多少

## 常见阻塞点分析

### 1. `init_verge_config()` 阻塞
可能原因：
- 配置文件损坏或格式错误
- 文件系统权限问题
- 磁盘 I/O 慢

解决方案：
- 检查配置文件完整性
- 检查文件系统权限
- 查看详细错误日志

### 2. `init_core_manager()` 阻塞
可能原因：
- 核心进程启动失败
- 服务连接超时
- 配置文件生成失败

解决方案：
- 检查核心二进制文件是否存在
- 检查服务状态
- 查看核心日志

### 3. `init_window()` 阻塞
可能原因：
- Tauri 窗口创建失败
- 系统资源不足
- 窗口管理器问题

解决方案：
- 检查系统资源
- 检查窗口管理器状态
- 查看 Tauri 日志

## 下一步调试建议

如果启动仍然失败：

1. **查看完整日志**：检查所有 `[启动诊断]` 标记的输出
2. **检查超时阶段**：找出哪个阶段超时了
3. **分析错误信息**：查看具体的错误消息
4. **逐步调试**：可以临时增加超时时间，看是否能完成
5. **使用性能分析工具**：如 `perf` (Linux) 或 `Instruments` (macOS)

## 注意事项

- 超时保护不会阻止应用启动，即使某个阶段超时，应用也会继续运行
- 超时时间是根据经验设置的，如果发现某个阶段经常超时，可能需要：
  - 优化该阶段的代码
  - 增加超时时间
  - 将该阶段移到后台异步执行

## 相关文件

- `src-tauri/src/utils/debug_startup.rs` - 诊断工具实现
- `src-tauri/src/utils/resolve/mod.rs` - 启动流程和超时保护
- `src-tauri/src/core/manager/lifecycle.rs` - 核心管理器生命周期
- `src-tauri/src/config/config.rs` - 配置初始化

